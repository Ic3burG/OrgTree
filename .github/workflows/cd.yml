name: CD

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main, develop]

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'

    steps:
      - name: Create pre-deployment backup
        run: |
          echo "Creating pre-deployment backup for staging..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://orgtree-staging.onrender.com/api/admin/backup" \
            -H "Authorization: Bearer ${{ secrets.BACKUP_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"type": "pre-deployment"}')

          if [ $response -eq 200 ]; then
            echo "✅ Pre-deployment backup created successfully"
          else
            echo "❌ Failed to create pre-deployment backup (HTTP $response)"
            exit 1
          fi

      - name: Trigger Render staging deployment
        run: curl -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK_URL }}"

      - name: Deployment notification
        env:
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "✅ Staging deployment initiated!"
          echo "Commit: $COMMIT_SHA"
          echo "Branch: $BRANCH"

  verify-staging:
    name: Verify Staging
    runs-on: ubuntu-latest
    needs: [deploy-staging]

    steps:
      - name: Health check with retry
        id: health_check
        run: |
          echo "Waiting for staging deployment to complete..."
          echo "This may take 2-3 minutes on Render's free tier..."
          echo ""

          max_attempts=10
          wait_time=20
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking health endpoint..."
            response=$(curl -s -o /dev/null -w "%{http_code}" https://orgtree-staging.onrender.com/api/health)

            if [ $response -eq 200 ]; then
              echo "✅ Health check passed (HTTP $response)"
              echo "Staging service is live and healthy!"
              exit 0
            else
              echo "⚠️  Health check returned HTTP $response"

              if [ $attempt -lt $max_attempts ]; then
                echo "Waiting ${wait_time}s before retry..."
                sleep $wait_time
              fi
            fi

            attempt=$((attempt + 1))
          done

          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

      - name: Auto-rollback on failure (Staging)
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          echo "⚠️ Staging health check failed. Triggering auto-rollback..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://orgtree-staging.onrender.com/api/admin/rollback/last" \
            -H "Authorization: Bearer ${{ secrets.BACKUP_API_TOKEN }}" \
            -H "Content-Type: application/json")

          if [ $response -eq 200 ]; then
            echo "✅ Auto-rollback triggered successfully"
          else
            echo "❌ Failed to trigger auto-rollback (HTTP $response)"
          fi

      - name: Staging deployment summary
        if: always()
        env:
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://orgtree-staging.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Staging deployment complete!" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: Create pre-deployment backup
        run: |
          echo "Creating pre-deployment backup for production..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://orgtree-app.onrender.com/api/admin/backup" \
            -H "Authorization: Bearer ${{ secrets.BACKUP_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"type": "pre-deployment"}')

          if [ $response -eq 200 ]; then
            echo "✅ Pre-deployment backup created successfully"
          else
            echo "❌ Failed to create pre-deployment backup (HTTP $response)"
            exit 1
          fi

      - name: Trigger Render production deployment
        run: curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

      - name: Deployment notification
        env:
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "✅ Production deployment initiated!"
          echo "Commit: $COMMIT_SHA"
          echo "Branch: $BRANCH"

  verify-production:
    name: Verify Production
    runs-on: ubuntu-latest
    needs: [deploy-production]

    steps:
      - name: Health check with retry
        id: health_check
        run: |
          echo "Waiting for production deployment to complete..."
          echo "This may take 2-3 minutes on Render's free tier..."
          echo ""

          max_attempts=10
          wait_time=20
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking health endpoint..."
            response=$(curl -s -o /dev/null -w "%{http_code}" https://orgtree-app.onrender.com/api/health)

            if [ $response -eq 200 ]; then
              echo "✅ Health check passed (HTTP $response)"
              echo "Production service is live and healthy!"
              exit 0
            else
              echo "⚠️  Health check returned HTTP $response"

              if [ $attempt -lt $max_attempts ]; then
                echo "Waiting ${wait_time}s before retry..."
                sleep $wait_time
              fi
            fi

            attempt=$((attempt + 1))
          done

          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

      - name: Auto-rollback on failure (Production)
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          echo "⚠️ Production health check failed. Triggering auto-rollback..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://orgtree-app.onrender.com/api/admin/rollback/last" \
            -H "Authorization: Bearer ${{ secrets.BACKUP_API_TOKEN }}" \
            -H "Content-Type: application/json")

          if [ $response -eq 200 ]; then
            echo "✅ Auto-rollback triggered successfully"
          else
            echo "❌ Failed to trigger auto-rollback (HTTP $response)"
          fi

      - name: Production deployment summary
        if: always()
        env:
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://orgtree-app.onrender.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Production deployment complete!" >> $GITHUB_STEP_SUMMARY
