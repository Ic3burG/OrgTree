#!/bin/sh

echo "Running pre-push checks..."

# Force ARM64 architecture (fixes x86 git spawning x86 node)
if [ "$(arch)" = "i386" ]; then
  exec arch -arm64 "$0" "$@"
fi

# Prettier check
echo "Checking code formatting with Prettier..."
npm run format:check && (cd server && npm run format:check)

if [ $? -ne 0 ]; then
  echo "Prettier check failed. Push aborted. Please run 'npm run format' and 'cd server && npm run format' to fix."
  exit 1
fi

# Run full test suite (frontend + backend)
# Run frontend tests
echo "Running frontend tests..."
npm test

# Run backend tests with strict coverage
echo "Running backend tests with strict coverage..."
(cd server && npm run test:coverage)

if [ $? -ne 0 ]; then
  echo "Tests failed. Push aborted."
  exit 1
fi

# Build check
echo "Verifying build..."
npm run build

if [ $? -ne 0 ]; then
  echo "Build failed. Push aborted."
  exit 1
fi

echo "Pre-push checks passed!"
