openapi: 3.0.3
info:
  title: OrgTree API
  description: |
    RESTful API for OrgTree - an organizational directory and visualization platform.

    ## Authentication
    Most endpoints require JWT authentication via Bearer token in the Authorization header.

    ## Rate Limiting
    - Authentication endpoints: 5 requests per 15 minutes per IP
    - Password reset: 10 requests per 15 minutes per IP
    - General API: No specific limits (recommended: implement client-side throttling)

    ## Real-time Updates
    OrgTree uses Socket.IO for real-time synchronization. Connect to the same server
    with your JWT token to receive live updates for organizations you're a member of.
  version: 1.0.0
  contact:
    name: OrgTree Support
      license:
        name: GPL 3.0
  servers:
  - url: http://localhost:3001/api
    description: Development server
  - url: https://orgtree-app.onrender.com/api
    description: Production server

tags:
  - name: Health
    description: Server health check
  - name: Authentication
    description: User registration, login, and session management
  - name: Organizations
    description: Organization CRUD operations
  - name: Departments
    description: Department management within organizations
  - name: People
    description: People/employee management
  - name: Members
    description: Organization member management and roles
  - name: Invitations
    description: Email invitation system
  - name: Search
    description: Full-text search across organizations
  - name: Bulk Operations
    description: Batch operations on people and departments
  - name: Audit
    description: Audit trail and activity logs
  - name: Import/Export
    description: Data import and export
  - name: Sharing
    description: Public sharing configuration
  - name: Users
    description: User management (superuser only)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from login endpoint

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
          example: "Error description"

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, superuser]
        createdAt:
          type: string
          format: date-time
        mustChangePassword:
          type: boolean

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
        user:
          $ref: '#/components/schemas/User'

    Organization:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        createdById:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        role:
          type: string
          enum: [owner, admin, editor, viewer]
          description: Current user's role in this organization

    Department:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        parentId:
          type: string
          format: uuid
          nullable: true
        name:
          type: string
        description:
          type: string
          nullable: true
        sortOrder:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Person:
      type: object
      properties:
        id:
          type: string
          format: uuid
        departmentId:
          type: string
          format: uuid
        name:
          type: string
        title:
          type: string
          nullable: true
        email:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        sortOrder:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Member:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        userName:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [viewer, editor, admin]
        createdAt:
          type: string
          format: date-time

    Invitation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [viewer, editor, admin]
        status:
          type: string
          enum: [pending, accepted, expired, cancelled]
        expiresAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        organizationName:
          type: string
        invitedByName:
          type: string

    AuditLog:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        actorId:
          type: string
          format: uuid
        actorName:
          type: string
        actorEmail:
          type: string
        actionType:
          type: string
          enum: [created, updated, deleted, settings_changed]
        entityType:
          type: string
          enum: [department, person, member, org, invitation]
        entityId:
          type: string
        entityName:
          type: string
        details:
          type: object
        createdAt:
          type: string
          format: date-time

    SearchResult:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [department, person]
              id:
                type: string
              name:
                type: string
              highlight:
                type: string
                description: Name with matched terms highlighted
              title:
                type: string
                nullable: true
              email:
                type: string
                nullable: true
              departmentId:
                type: string
                nullable: true
              departmentName:
                type: string
                nullable: true
        total:
          type: integer
        hasMore:
          type: boolean

    BulkResult:
      type: object
      properties:
        success:
          type: boolean
        deletedCount:
          type: integer
        updatedCount:
          type: integer
        movedCount:
          type: integer
        failedCount:
          type: integer
        deleted:
          type: array
          items:
            type: string
        updated:
          type: array
          items:
            type: string
        failed:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              error:
                type: string

    ShareSettings:
      type: object
      properties:
        isPublic:
          type: boolean
        shareToken:
          type: string
          nullable: true
        shareUrl:
          type: string
          format: uri
          nullable: true

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Access token required"

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Access denied"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Resource not found"

    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

security:
  - bearerAuth: []

paths:
  # ==================== HEALTH ====================
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check server and database connectivity
      security: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  database:
                    type: string
                    example: connected
                  environment:
                    type: string
                    example: production

  # ==================== AUTHENTICATION ====================
  /auth/signup:
    post:
      tags: [Authentication]
      summary: Register new user
      description: Create a new user account. Rate limited to 5 requests per 15 minutes.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                  minLength: 1
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          description: Rate limit exceeded

  /auth/login:
    post:
      tags: [Authentication]
      summary: User login
      description: Authenticate and receive JWT token. Rate limited to 5 requests per 15 minutes.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Invalid credentials
        '429':
          description: Rate limit exceeded

  /auth/me:
    get:
      tags: [Authentication]
      summary: Get current user
      description: Get the authenticated user's profile
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/change-password:
    post:
      tags: [Authentication]
      summary: Change password
      description: Change the authenticated user's password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [newPassword]
              properties:
                newPassword:
                  type: string
                  minLength: 6
      responses:
        '200':
          description: Password changed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==================== ORGANIZATIONS ====================
  /organizations:
    get:
      tags: [Organizations]
      summary: List organizations
      description: Get all organizations the user has access to
      responses:
        '200':
          description: List of organizations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Organizations]
      summary: Create organization
      description: Create a new organization. The creator becomes the owner.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  minLength: 1
      responses:
        '201':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /organizations/{orgId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Organizations]
      summary: Get organization
      description: Get organization details
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Organizations]
      summary: Update organization
      description: Update organization name. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  minLength: 1
      responses:
        '200':
          description: Organization updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags: [Organizations]
      summary: Delete organization
      description: Delete organization and all its data. Requires owner role.
      responses:
        '204':
          description: Organization deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== SHARING ====================
  /organizations/{orgId}/share:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Sharing]
      summary: Get share settings
      description: Get public sharing configuration. Requires viewer role or above.
      responses:
        '200':
          description: Share settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    put:
      tags: [Sharing]
      summary: Update share settings
      description: Enable/disable public sharing. Requires admin role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [isPublic]
              properties:
                isPublic:
                  type: boolean
      responses:
        '200':
          description: Share settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/share/regenerate:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Sharing]
      summary: Regenerate share token
      description: Generate a new share URL, invalidating the old one. Requires admin role.
      responses:
        '200':
          description: New share token generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShareSettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== DEPARTMENTS ====================
  /organizations/{orgId}/departments:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Departments]
      summary: List departments
      description: Get all departments in an organization
      responses:
        '200':
          description: List of departments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Department'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [Departments]
      summary: Create department
      description: Create a new department. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  minLength: 1
                description:
                  type: string
                parentId:
                  type: string
                  format: uuid
                  nullable: true
                  description: Parent department ID for nested hierarchy
      responses:
        '201':
          description: Department created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/departments/{deptId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: deptId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Departments]
      summary: Get department
      description: Get department details
      responses:
        '200':
          description: Department details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Departments]
      summary: Update department
      description: Update department details. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                description:
                  type: string
                parentId:
                  type: string
                  format: uuid
                  nullable: true
      responses:
        '200':
          description: Department updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Department'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags: [Departments]
      summary: Delete department
      description: Delete department and optionally its children. Requires editor role or above.
      responses:
        '204':
          description: Department deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== PEOPLE ====================
  /departments/{deptId}/people:
    parameters:
      - name: deptId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [People]
      summary: List people in department
      description: Get all people in a department
      responses:
        '200':
          description: List of people
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Person'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [People]
      summary: Create person
      description: Add a new person to a department. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  minLength: 1
                title:
                  type: string
                email:
                  type: string
                  format: email
                phone:
                  type: string
      responses:
        '201':
          description: Person created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /people/{personId}:
    parameters:
      - name: personId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [People]
      summary: Get person
      description: Get person details
      responses:
        '200':
          description: Person details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [People]
      summary: Update person
      description: Update person details. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                title:
                  type: string
                email:
                  type: string
                  format: email
                phone:
                  type: string
                departmentId:
                  type: string
                  format: uuid
                  description: Move person to different department
      responses:
        '200':
          description: Person updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags: [People]
      summary: Delete person
      description: Remove person from organization. Requires editor role or above.
      responses:
        '204':
          description: Person deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /people/{personId}/move:
    parameters:
      - name: personId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [People]
      summary: Move person
      description: Move person to a different department. Requires editor role or above.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [departmentId]
              properties:
                departmentId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Person moved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Person'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== MEMBERS ====================
  /organizations/{orgId}/members:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Members]
      summary: List members
      description: Get all members of an organization. Requires admin role.
      responses:
        '200':
          description: Organization members
          content:
            application/json:
              schema:
                type: object
                properties:
                  owner:
                    type: object
                    properties:
                      userId:
                        type: string
                      userName:
                        type: string
                      userEmail:
                        type: string
                      role:
                        type: string
                        enum: [owner]
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/Member'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [Members]
      summary: Add member by user ID
      description: Add a user to the organization. Requires admin role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId, role]
              properties:
                userId:
                  type: string
                  format: uuid
                role:
                  type: string
                  enum: [viewer, editor, admin]
      responses:
        '201':
          description: Member added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/members/by-email:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Members]
      summary: Add member by email
      description: Add a user by email. Returns success:false if user not found. Requires admin role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, role]
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [viewer, editor, admin]
      responses:
        '200':
          description: User not found (can send invitation instead)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: user_not_found
        '201':
          description: Member added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  member:
                    $ref: '#/components/schemas/Member'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/members/{memberId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: memberId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [Members]
      summary: Update member role
      description: Change a member's role. Requires admin role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  enum: [viewer, editor, admin]
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags: [Members]
      summary: Remove member
      description: Remove a member from the organization. Requires admin role.
      responses:
        '204':
          description: Member removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== INVITATIONS ====================
  /organizations/{orgId}/invitations:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Invitations]
      summary: List invitations
      description: Get pending invitations for an organization. Requires admin role.
      responses:
        '200':
          description: List of invitations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Invitation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [Invitations]
      summary: Send invitation
      description: Send an email invitation to join the organization. Requires admin role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, role]
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [viewer, editor, admin]
      responses:
        '201':
          description: Invitation sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invitation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/invitations/{invitationId}:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid
      - name: invitationId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    delete:
      tags: [Invitations]
      summary: Cancel invitation
      description: Cancel a pending invitation. Requires admin role.
      responses:
        '204':
          description: Invitation cancelled
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /invitations/{token}:
    parameters:
      - name: token
        in: path
        required: true
        schema:
          type: string

    get:
      tags: [Invitations]
      summary: Get invitation by token
      description: Get invitation details. No authentication required.
      security: []
      responses:
        '200':
          description: Invitation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invitation'
        '404':
          $ref: '#/components/responses/NotFound'

  /invitations/{token}/accept:
    parameters:
      - name: token
        in: path
        required: true
        schema:
          type: string

    post:
      tags: [Invitations]
      summary: Accept invitation
      description: Accept an invitation and join the organization
      responses:
        '200':
          description: Invitation accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  organization:
                    $ref: '#/components/schemas/Organization'
        '400':
          description: Invalid or expired invitation
        '401':
          $ref: '#/components/responses/Unauthorized'

  /invitations/status:
    get:
      tags: [Invitations]
      summary: Check email service status
      description: Check if email invitations are configured
      responses:
        '200':
          description: Email service status
          content:
            application/json:
              schema:
                type: object
                properties:
                  emailConfigured:
                    type: boolean

  # ==================== SEARCH ====================
  /organizations/{orgId}/search:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Search]
      summary: Full-text search
      description: Search across departments and people with FTS5
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
          description: Search query
        - name: type
          in: query
          schema:
            type: string
            enum: [all, departments, people]
            default: all
          description: Filter by entity type
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /organizations/{orgId}/search/autocomplete:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Search]
      summary: Autocomplete suggestions
      description: Fast prefix-based suggestions for search
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
          description: Partial search query
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 10
            default: 5
      responses:
        '200':
          description: Autocomplete suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      type: object
                      properties:
                        text:
                          type: string
                        type:
                          type: string
                          enum: [department, person]
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==================== BULK OPERATIONS ====================
  /organizations/{orgId}/people/bulk-delete:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Bulk Operations]
      summary: Bulk delete people
      description: Delete multiple people at once. Max 100 items. Requires editor role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [personIds]
              properties:
                personIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 100
      responses:
        '200':
          description: Bulk delete result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/people/bulk-move:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Bulk Operations]
      summary: Bulk move people
      description: Move multiple people to a department. Max 100 items. Requires editor role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [personIds, targetDepartmentId]
              properties:
                personIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 100
                targetDepartmentId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Bulk move result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/people/bulk-edit:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [Bulk Operations]
      summary: Bulk edit people
      description: Update fields on multiple people. Max 100 items. Requires editor role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [personIds, updates]
              properties:
                personIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 100
                updates:
                  type: object
                  properties:
                    title:
                      type: string
                    departmentId:
                      type: string
                      format: uuid
      responses:
        '200':
          description: Bulk edit result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/departments/bulk-delete:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Bulk Operations]
      summary: Bulk delete departments
      description: Delete multiple departments. Max 100 items. Requires editor role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [departmentIds]
              properties:
                departmentIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 100
      responses:
        '200':
          description: Bulk delete result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /organizations/{orgId}/departments/bulk-edit:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [Bulk Operations]
      summary: Bulk edit departments
      description: Update fields on multiple departments (mainly re-parenting). Max 100 items. Requires editor role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [departmentIds, updates]
              properties:
                departmentIds:
                  type: array
                  items:
                    type: string
                    format: uuid
                  maxItems: 100
                updates:
                  type: object
                  properties:
                    parentId:
                      type: string
                      format: uuid
                      nullable: true
                      description: Set to null for root level
      responses:
        '200':
          description: Bulk edit result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== AUDIT ====================
  /organizations/{orgId}/audit-logs:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Audit]
      summary: Get audit logs
      description: Get audit logs for an organization. Requires admin role.
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: cursor
          in: query
          schema:
            type: string
          description: Pagination cursor from previous response
        - name: actionType
          in: query
          schema:
            type: string
            enum: [created, updated, deleted, settings_changed]
        - name: entityType
          in: query
          schema:
            type: string
            enum: [department, person, member, org, invitation]
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Audit logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLog'
                  nextCursor:
                    type: string
                    nullable: true
                  hasMore:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /admin/audit-logs:
    get:
      tags: [Audit]
      summary: Get all audit logs (superuser)
      description: Get audit logs across all organizations. Requires superuser role.
      parameters:
        - name: orgId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by organization
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: cursor
          in: query
          schema:
            type: string
        - name: actionType
          in: query
          schema:
            type: string
            enum: [created, updated, deleted, settings_changed]
        - name: entityType
          in: query
          schema:
            type: string
            enum: [department, person, member, org, invitation]
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Audit logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditLog'
                  nextCursor:
                    type: string
                    nullable: true
                  hasMore:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== IMPORT ====================
  /organizations/{orgId}/import:
    parameters:
      - name: orgId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Import/Export]
      summary: Import data
      description: Import departments and people from parsed CSV data. Requires owner role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [data]
              properties:
                data:
                  type: array
                  items:
                    type: object
                    required: [path, type, name]
                    properties:
                      path:
                        type: string
                        description: Hierarchical path (e.g., /Finance/Accounting)
                      type:
                        type: string
                        enum: [department, person]
                      name:
                        type: string
                      title:
                        type: string
                      email:
                        type: string
                      phone:
                        type: string
                      description:
                        type: string
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  departmentsCreated:
                    type: integer
                  peopleCreated:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== PUBLIC ====================
  /public/org/{shareToken}:
    parameters:
      - name: shareToken
        in: path
        required: true
        schema:
          type: string

    get:
      tags: [Sharing]
      summary: Get public organization
      description: Get organization data via public share token. No authentication required.
      security: []
      responses:
        '200':
          description: Public organization data
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  name:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  departments:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/Department'
                        - type: object
                          properties:
                            people:
                              type: array
                              items:
                                $ref: '#/components/schemas/Person'
        '404':
          $ref: '#/components/responses/NotFound'

  /public/invitation/{token}:
    parameters:
      - name: token
        in: path
        required: true
        schema:
          type: string

    get:
      tags: [Invitations]
      summary: Get public invitation
      description: Get invitation details by token. No authentication required.
      security: []
      responses:
        '200':
          description: Invitation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invitation'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== USERS (SUPERUSER) ====================
  /users:
    get:
      tags: [Users]
      summary: List all users
      description: Get all users in the system. Requires superuser role.
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags: [Users]
      summary: Create user
      description: Create a new user with temporary password. Requires superuser role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, role]
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [user, superuser]
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  temporaryPassword:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Users]
      summary: Get user
      description: Get user details. Requires superuser role.
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Users]
      summary: Update user
      description: Update user name/email. Requires superuser role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      tags: [Users]
      summary: Delete user
      description: Delete a user. Cannot delete self. Requires superuser role.
      responses:
        '204':
          description: User deleted
        '400':
          description: Cannot delete self
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{userId}/role:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags: [Users]
      summary: Change user role
      description: Change user's system role. Cannot change own role. Requires superuser role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  enum: [user, superuser]
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Cannot change own role
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /users/{userId}/reset-password:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Users]
      summary: Reset user password
      description: Reset user's password to a temporary one. Rate limited. Requires superuser role.
      responses:
        '200':
          description: Password reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  temporaryPassword:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          description: Rate limit exceeded
